# Matchmaking service

### Описание
Сервис предоставляет функционал по формированию команд из имеющегося пула пользователей. Ползователи регистрируются через открытый RestAPI.

### API
    http(s)://[service_address]/users 
*(http://localhost:8085/users)*

### Configs
Конфигурация задается через перерменные окружения (ENV):
- **SERVER_PORT** - порт приложения *(8085)*;
- **COMMON_LOG_LEVEL** - общий уровень логирования *(INFO)*;
- **APP_LOG_LEVEL** - уровень логирования приложения *(DEBUG)*;
- **LOGGING_CONFIG_PATH** - путь до конфигурации логера *(classpath:log4j2.yml)*;
- **MONGODB_URI** - адрес БД *(mongodb://localhost:27017/matchmaking)*;
- **POOL_PROCESSING_DELAY** - период чтения зарегистрированных участников и формирования команд *(3000)*;
- **GROUP_SIZE**  - размер команд *(3)*

### Реализация
1. Через конфигурацию задаются так называемые группы индекса. Они позволяют определять способ первичной сортировки пользователей в пуле ожидания;
2. После этого сортировка идет по скил и латенси. Таким образом даже при переходе с одного индекса на другой(пограничные юзеры будут хоть как то коррелировать с требованиями друг друга);
3. Раз в заданный промежуток времени (1 секунда например) сервис ходит в БД и вычитывает записи регистрации которым еще не присвоен номер команды;
4. Вычитанные записи регистрации сортируются по описанному выше образу (ИндексСовместимости, Скилл, Латенси);
5. Идет пробег по всем отсортированным записям и формируются команды по законфигурированному размеру команды;
6. Регистрациям с присвоенными командами обновляются данные в БД;
7. Те кому не хватило человек просто игнорируются и попадут в следующую выборку.
8. Конфигурация сделана через ENV чтобы можно было конфигурировать балансировку юзеров через переменные окружения и почти в онлайне перезапускать сервис с новым конфигов. Это позволит пользователей уже вставших в очередь обработать с новым конфигом.
9. Пользователи пока храняться в незапароленной монге, в силу того, что это был быстрый вариант развертывания окружения.

### TODO
1. Послабление требований в подборе команды при увеличении времени ожидания. Планировалось ввести пороги ожидания и при формировании команды проверять, что разница в коэффициентах проверяется в зависимости от времени ожидания проверяемого юзера;
2. Нет тестов;
3. Если будет большой набор юзеров и необходима будет пагинация, то всегда будут неактуалные пачки выборки(смещения при сортировке), необходимо это отработать;
4. Добавить признак захвата транзакцией регистрационной записи в БД, чтобы была возможность масштабировать сервис и прикрыть конкуренцию между инстансами сервиса относительно записей в БД. Ну и так, если обработка считаного числа участников продлиться более секунды, то так же конкуренция на данных будет.;
5. Добавить refreshable конфиги, позволяющие заниматься предварительной подготовкой конфигов и применению их в онлайне.
6. Не подготовлен нормальный тест кейс.